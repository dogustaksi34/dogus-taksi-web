{
  "name": "VAPI - WhatsApp Bildirim (Evolution API)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "vapi-admin-bildir",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "vapi-webhook-bildir",
      "name": "Vapi Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [480, -960],
      "webhookId": "vapi-bildir-001"
    },
    {
      "parameters": {
        "jsCode": "// ========================================================\n// AYARLAR\n// ========================================================\nconst HEDEF_GRUP_ID = \"120363403069550375@g.us\";\nconst API_URL = \"https://evoyeni.beykentkorsantaksi.shop\";\nconst INSTANCE_ADI = \"ERDAL BURKUT\";\nconst API_KEY = \"1F56759F1A2F-4177-8869-41E5990F1209\";\n\n// ========================================================\n// VAPI VERÄ°SÄ°NÄ° Ã‡Ã–Z\n// ========================================================\nlet data = items[0].json;\nif (data.body) data = data.body;\n\nconst message = data.message || data;\nconst call = message.call || data.call || {};\nconst customer = message.customer || call.customer || {};\n\n// toolCallId'yi al\nlet toolCallId = '';\nif (message?.toolCalls && message.toolCalls.length > 0) {\n  toolCallId = message.toolCalls[0]?.id || '';\n} else if (message?.toolCallList && message.toolCallList.length > 0) {\n  toolCallId = message.toolCallList[0]?.id || '';\n}\n\n// Parametreleri al\nlet params = {};\nif (message?.toolCalls && message.toolCalls.length > 0) {\n  params = message.toolCalls[0]?.function?.arguments || {};\n} else if (message?.toolCallList && message.toolCallList.length > 0) {\n  params = message.toolCallList[0]?.function?.arguments || {};\n} else if (message?.functionCall?.parameters) {\n  params = message.functionCall.parameters;\n} else if (data?.args) {\n  params = data.args;\n}\n\nif (typeof params === 'string') {\n  try { params = JSON.parse(params); } catch (e) { params = {}; }\n}\n\n// Talep tipi etiketleri\nconst talepTipleri = {\n  'buyuk_arac': 'ğŸš BÃ¼yÃ¼k AraÃ§ Talebi',\n  'iptal_talebi': 'âŒ Ä°ptal Talebi',\n  'taksi_nerede': 'ğŸ“ Taksi Nerede?',\n  'gidis_donus': 'ğŸ”„ GidiÅŸ-DÃ¶nÃ¼ÅŸ',\n  'evcil_hayvan': 'ğŸ¾ Evcil Hayvan',\n  'vip_talep': 'â­ VIP Talep',\n  'sistem_hatasi': 'âš ï¸ Sistem HatasÄ±',\n  'diger': 'ğŸ“‹ DiÄŸer'\n};\n\n// Verileri Ã§Ä±kar\nconst guvenliInstanceAdi = encodeURIComponent(INSTANCE_ADI);\n\n// MÃ¼ÅŸteri numarasÄ± - Vapi SIP aramalarda customer.name iÃ§inde geliyor\nlet musteriNo = 'Numara Gizli';\nif (customer.name && /\\d{10,}/.test(String(customer.name).replace(/\\D/g, ''))) {\n  musteriNo = customer.name;\n} else if (customer.number) {\n  musteriNo = customer.number;\n} else if (call.from_number) {\n  musteriNo = call.from_number;\n} else if (params.telefon_numarasi) {\n  musteriNo = params.telefon_numarasi;\n}\n\nconst musteriIsmi = params.musteri_ismi || \"Bilinmiyor\";\nconst talepTipi = talepTipleri[params.talep_tipi] || params.talep_tipi || \"Genel\";\nconst detay = params.detay || \"Detay yok\";\nconst cikis = params.cikis_noktasi || \"\";\nconst varis = params.varis_noktasi || \"\";\n\nconst tarih = new Date().toLocaleString('tr-TR', { timeZone: 'Europe/Istanbul' });\n\n// Mesaj Metni\nlet mesaj = `ğŸš¨ *DOÄUÅ TAKSÄ° - YENÄ° BÄ°LDÄ°RÄ°M*\\n\\n${talepTipi}\\n\\nğŸ“ *MÃ¼ÅŸteri:* ${musteriIsmi}\\nğŸ“± *Telefon:* ${musteriNo}\\nğŸ“… *Tarih:* ${tarih}`;\n\nif (cikis) mesaj += `\\nğŸ“ *Ã‡Ä±kÄ±ÅŸ:* ${cikis}`;\nif (varis) mesaj += `\\nğŸ¯ *VarÄ±ÅŸ:* ${varis}`;\n\nmesaj += `\\n\\nğŸ“ *Detay:* ${detay}`;\n\nreturn {\n  json: {\n    target_jid: HEDEF_GRUP_ID,\n    message_text: mesaj,\n    apiUrlText: `${API_URL}/message/sendText/${guvenliInstanceAdi}`,\n    apiKey: API_KEY,\n    toolCallId: toolCallId\n  }\n};"
      },
      "id": "code-ayarla",
      "name": "AyarlarÄ± YapÄ±landÄ±r",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, -960]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.apiUrlText }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $json.apiKey }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $json.target_jid }}"
            },
            {
              "name": "text",
              "value": "={{ $json.message_text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-whatsapp",
      "name": "WhatsApp Mesaj GÃ¶nder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1024, -960]
    },
    {
      "parameters": {
        "jsCode": "const toolCallId = $('AyarlarÄ± YapÄ±landÄ±r').item.json.toolCallId || '';\n\n// VAPI FORMATI - results array ile toolCallId\nreturn {\n  json: {\n    results: [\n      {\n        toolCallId: toolCallId,\n        result: \"Yetkili arkadaÅŸÄ±mÄ±za bildirim gÃ¶nderildi, 2 dakika iÃ§inde sizi arayacaklar.\"\n      }\n    ]\n  }\n};"
      },
      "id": "code-yanit",
      "name": "YanÄ±t HazÄ±rla",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1248, -960]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "response-bildir",
      "name": "YanÄ±t GÃ¶nder",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1456, -960]
    }
  ],
  "pinData": {},
  "connections": {
    "Vapi Webhook": {
      "main": [
        [
          {
            "node": "AyarlarÄ± YapÄ±landÄ±r",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AyarlarÄ± YapÄ±landÄ±r": {
      "main": [
        [
          {
            "node": "WhatsApp Mesaj GÃ¶nder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Mesaj GÃ¶nder": {
      "main": [
        [
          {
            "node": "YanÄ±t HazÄ±rla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "YanÄ±t HazÄ±rla": {
      "main": [
        [
          {
            "node": "YanÄ±t GÃ¶nder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
